name: Deploy to Production

on:
  push:
    branches:
      - main  # Main branch for production deployment (Hetzner Kubernetes)
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free disk space
        run: |
          echo "=== Checking disk space ==="
          df -h
          echo "=== Cleaning up disk space ==="
          pip cache purge || true
          sudo apt-get clean || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          sudo rm -rf ~/.cache/pip || true
          sudo rm -rf /tmp/* || true
          echo "=== Disk space after cleanup ==="
          df -h
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r backend/requirements.txt || true
      
      - name: Check for syntax errors
        run: |
          find backend -name "*.py" \
            -not -path "*/venv*/*" \
            -not -path "*/.git/*" \
            -not -path "*/__pycache__/*" \
            -exec python -m py_compile {} \; || true
      
      - name: Cleanup after tests
        if: always()
        run: |
          echo "=== Final cleanup ==="
          pip cache purge || true
          sudo apt-get clean || true
          rm -rf __pycache__ || true
          find . -type d -name __pycache__ -exec rm -rf {} + || true

  deploy-production:
    name: Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_PRIVATE_KEY }}" > ~/.ssh/hetzner_key
          chmod 600 ~/.ssh/hetzner_key
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Hetzner Kubernetes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REF: ${{ github.ref }}
          FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SSH_OPTS: "-i ~/.ssh/hetzner_key -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ConnectTimeout=30"
        run: |
          echo "=== Deploying to Hetzner Kubernetes ==="
          
          # Upload source code to Hetzner and build there
          echo "=== Uploading source code to Hetzner ==="
          tar --exclude='.git' --exclude='venv' --exclude='node_modules' --exclude='__pycache__' --exclude='*.pyc' --exclude='.env' --exclude='backend/chromadb_data' --exclude='backend/database' --exclude='*.db' --exclude='*.sqlite*' --exclude='logs' --exclude='dist' -czf /tmp/airepubliq-source.tar.gz .
          scp ${SSH_OPTS} /tmp/airepubliq-source.tar.gz root@${{ secrets.HETZNER_HOST }}:/tmp/
          rm -f /tmp/airepubliq-source.tar.gz
          
          # Build Docker images directly on Hetzner server
          echo "=== Building Docker images on Hetzner ==="
          ssh ${SSH_OPTS} root@${{ secrets.HETZNER_HOST }} bash -s << DEPLOY_SCRIPT
            set -e
            set -o pipefail
            
            # Set environment variables from GitHub Actions
            FLASK_SECRET_KEY='${FLASK_SECRET_KEY}'
            POSTGRES_PASSWORD='${POSTGRES_PASSWORD}'
            
            cd /tmp
            rm -rf airepubliq-build || true
            mkdir -p airepubliq-build
            cd airepubliq-build
            tar -xzf /tmp/airepubliq-source.tar.gz
            rm /tmp/airepubliq-source.tar.gz

            echo "=== Checking disk space before build ==="
            df -h
            echo ""
            echo "=== Cleaning up Docker resources ==="
            docker system prune -af --volumes || true
            docker builder prune -af || true
            echo ""
            echo "=== Disk space after cleanup ==="
            df -h
            echo ""
            echo "=== Building Docker images ==="
            
            echo "Removing old airepubliq images..."
            docker rmi airepubliq-backend:latest airepubliq-frontend:latest 2>/dev/null || true
            
            echo "Building backend Docker image..."
            docker build -f backend/Dockerfile -t airepubliq-backend:latest . || {
              echo "Backend Docker build failed"
              exit 1
            }
            
            echo "Building frontend Docker image..."
            docker build -f frontend/Dockerfile -t airepubliq-frontend:latest . || {
              echo "Frontend Docker build failed"
              exit 1
            }
            
            echo "Importing images into k3s..."
            docker save airepubliq-backend:latest | k3s ctr images import - || {
              echo "Backend image import failed"
              exit 1
            }
            docker save airepubliq-frontend:latest | k3s ctr images import - || {
              echo "Frontend image import failed"
              exit 1
            }
            
            echo "Cleaning up Docker images after import..."
            docker rmi airepubliq-backend:latest airepubliq-frontend:latest 2>/dev/null || true
            docker system prune -f || true
            
            echo "Applying Kubernetes manifests..."
            if [ ! -d "/tmp/airepubliq-k8s" ]; then
              mkdir -p /tmp/airepubliq-k8s
            fi
            cp -r k8s/* /tmp/airepubliq-k8s/ 2>/dev/null || true
            
            # Apply manifests if they exist
            if [ -d "/tmp/airepubliq-k8s" ] && [ "$(ls -A /tmp/airepubliq-k8s/*.yaml 2>/dev/null)" ]; then
              kubectl apply -f /tmp/airepubliq-k8s/namespace.yaml || true
              
              # Create/update PostgreSQL secret
              if [ -n "\${POSTGRES_PASSWORD}" ]; then
                kubectl create secret generic postgres-secrets \
                  --from-literal=postgres-db='ai_refinement_v2' \
                  --from-literal=postgres-user='airepublic' \
                  --from-literal=postgres-password="\${POSTGRES_PASSWORD}" \
                  -n airepubliq \
                  --dry-run=client -o yaml | kubectl apply -f - || true
              fi
              
              # Create/update backend secret
              if [ -n "\${FLASK_SECRET_KEY}" ]; then
                DATABASE_URL="postgresql://airepublic:\${POSTGRES_PASSWORD}@postgres-service.airepubliq.svc.cluster.local:5432/ai_refinement_v2"
                kubectl create secret generic backend-secrets \
                  --from-literal=flask-env='production' \
                  --from-literal=database-url="\${DATABASE_URL}" \
                  --from-literal=redis-url='redis://redis-service.airepubliq.svc.cluster.local:6379/0' \
                  --from-literal=secret-key="\${FLASK_SECRET_KEY}" \
                  -n airepubliq \
                  --dry-run=client -o yaml | kubectl apply -f - || true
              fi
              
              kubectl apply -f /tmp/airepubliq-k8s/postgres-deployment.yaml || true
              kubectl apply -f /tmp/airepubliq-k8s/redis-deployment.yaml || true
              kubectl apply -f /tmp/airepubliq-k8s/backend-deployment.yaml || true
              kubectl apply -f /tmp/airepubliq-k8s/frontend-deployment.yaml || true
              kubectl apply -f /tmp/airepubliq-k8s/ingress.yaml || true
              
              echo "Restarting deployments..."
              kubectl rollout restart deployment/backend-app -n airepubliq || true
              kubectl rollout restart deployment/frontend-app -n airepubliq || true
              
              kubectl rollout status deployment/backend-app -n airepubliq --timeout=120s || {
                echo "Backend deployment status check timed out"
              }
              kubectl rollout status deployment/frontend-app -n airepubliq --timeout=120s || {
                echo "Frontend deployment status check timed out"
              }
            else
              echo "Kubernetes manifests not found, skipping kubectl apply"
            fi
            
            echo "Cleaning up..."
            cd /
            rm -rf /tmp/airepubliq-build
            rm -rf /tmp/airepubliq-k8s
            
            echo "Deployment complete"
          DEPLOY_SCRIPT
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f ${{ secrets.HETZNER_APP_URL || 'https://airepubliq.com' }}/api/status || echo "Health check failed, but deployment may still be in progress"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Production deployment successful!"
          else
            echo "Production deployment failed!"
          fi
